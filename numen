#!/bin/sh

if ! command -v arecord > /dev/null; then
	echo 'numen requires the alsa-utils package.' >&2
	exit 1
fi

mkdir -p "${XDG_DATA_HOME:-$HOME/.local/share}/numen/mods"
handler=handlers/kernel
mic=
model="${NUMEN_MODEL:-model}"
args="$(getopt -n numen -o h -l help,kernel,list-mics,mic:,version,x11 -- "$@")" || exit
eval set -- "$args"
while :; do
	case "$1" in
	-h|--help) echo 'numen [PHRASE_FILE...]
--kernel       Use the kernel handler to perform the actions (the default).
--list-mics    List audio devices and exit.
--mic=NAME     Select the audio device.
--version      Print the version and exit.
--x11          Use the X11 handler to perform the actions.'; exit;;
	--kernel) handler=handlers/kernel; shift;;
	--list-mics) arecord -L | sed -E '/^sysdefault:/ !d; s/.*=//; N'; exit;;
	--mic) mic="$2"; shift 2;;
	--version) printf %s\\n "$NUMEN_VERSION"; exit;;
	--x11) handler=handlers/x11; shift;;
	--) shift; break;;
	esac
done

if [ $# = 0 ]; then
	if [ -d "${XDG_CONFIG_HOME:-$HOME/.config}"/numen/phrases ]; then
		set -- "${XDG_CONFIG_HOME:-$HOME/.config}/numen/phrases/"*.phrases
	else
		set -- /etc/numen/phrases/*.phrases
	fi
fi

tmpdir="$(mktemp -d)"
trap 'rm -rf "$tmpdir"; pkill -P $$; trap - EXIT; exit' EXIT INT TERM HUP
pipe="$tmpdir/pipe"
mkfifo -m 600 "$pipe" || exit
./record "$mic" | ./speech "$model" "$@" | ./scribe > "$pipe" &

export NUMEN_HANDLER="${handler#*/}"
export NUMEN_SHELL="${NUMEN_SHELL:-/bin/sh}"
export NUMEN_KEY_DELAY="${NUMEN_KEY_DELAY:-8}"
export NUMEN_TYPE_DELAY="${NUMEN_TYPE_DELAY:-4}"
./instructor < "$pipe" | "$handler" "$pipe" &
wait
